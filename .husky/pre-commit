#!/bin/sh

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' || true)

# If no relevant files staged, skip hooks
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Optional: Supabase TypeScript generation (warn only, don't block)
if echo "$STAGED_FILES" | grep -q '^services/supabase/'; then
  echo "ðŸ”µ Running Supabase TypeScript generation (optional)..."
  if (cd services/supabase && bun gen 2>/dev/null); then
    echo "âœ… Supabase types generated successfully"
  else
    echo "âš ï¸  Supabase TypeScript generation skipped (not blocking commit)"
  fi
fi

# Format staged files only with Prettier (non-blocking)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 prettier --write --ignore-unknown 2>/dev/null || true
fi

# Lint and format only staged files with Biome (non-blocking)
if [ -n "$STAGED_FILES" ]; then
  echo "ðŸ”µ Running Biome on staged files..."
  echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 bunx biome check --write --no-errors-on-unmatched 2>/dev/null || {
    echo "âš ï¸  Biome found issues. Review and fix if needed (not blocking commit)"
  }
fi

# Re-stage files that were auto-formatted
git update-index --again 2>/dev/null || true
